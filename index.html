<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StudyTimer — 勉強時間記録</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --panel:#151821; --text:#e7e9ee; --muted:#a7adbb; --brand:#6aa6ff; --brand-2:#82e9a6; --danger:#ff6b6b;
      --ring: rgba(106,166,255,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background:var(--bg); color:var(--text); line-height:1.6;
    }
    .container{ max-width:1024px; margin:0 auto; padding:16px; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:8px 0 16px; }
    .title{ font-size: clamp(20px, 3vw, 28px); font-weight:700; letter-spacing:.3px; display:flex; align-items:center; gap:10px; }
    .title .dot{ width:10px; height:10px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); border-radius:50%; box-shadow:0 0 0 4px rgba(130,233,166,.15)}
    .row{ display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width:860px){ .row{ grid-template-columns: 1.1fr .9fr; } }
    .card{ background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2{ margin:0 0 8px; font-size:18px; }
    .muted{ color:var(--muted); font-size:12px; }
    .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    select, input[type="text"], input[type="number"], input[type="file"]{
      background:#0f1118; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px 12px;
      outline:none; min-width:120px;
    }
    select:focus, input:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); }
    button{
      background:linear-gradient(135deg,var(--brand),#528dff); color:#fff; border:none; border-radius:999px; padding:10px 14px; font-weight:700;
      cursor:pointer; transition:.15s transform, .15s filter;
    }
    button:hover{ transform: translateY(-1px); filter:brightness(1.03);} 
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,.12); color:var(--text); }
    .btn-danger{ background: linear-gradient(135deg, var(--danger), #ff4d4d); }
    .timer{
      font-variant-numeric: tabular-nums; font-size: clamp(32px, 6vw, 48px); font-weight:800; letter-spacing:1px;
      padding: 6px 0 2px; display:flex; align-items:center; gap:10px;
    }
    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:12px; }
    .kpi{ background: #0f1118; border:1px solid rgba(255,255,255,.06); padding:10px; border-radius:12px; text-align:center; }
    .kpi .val{ font-size:20px; font-weight:800; }
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; }
    .chip{ background:#0f1118; border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:6px 10px; font-size:12px; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-size:14px; }
    th{ text-align:left; color:#cfd3de; font-weight:600; }
    tbody tr:hover{ background: rgba(255,255,255,.03); }

    .footer{ margin:24px 0 40px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .right{ display:flex; gap:8px; align-items:center; }
    .subject-row{ display:flex; gap:8px; align-items:center; }
    .subject-list{ display:flex; flex-wrap:wrap; gap:6px; }
    .subject-pill{ display:flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#0f1118; border:1px solid rgba(255,255,255,.08); font-size:12px; }
    .subject-pill button{ padding:4px 8px; border-radius:999px; background:transparent; border:1px solid rgba(255,255,255,.12); font-size:12px; }

    .tiny{ font-size:11px; color:#9aa3b2 }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title"><span class="dot"></span>StudyTimer <span class="muted">— 勉強時間の記録</span></div>
      <div class="right">
        <button class="btn-ghost" id="toggleThemeBtn" title="ライト/ダーク切替">🌓 テーマ</button>
        <button class="btn-ghost" id="exportBtn" title="JSONエクスポート">⤴︎ エクスポート</button>
        <label class="btn-ghost" for="importFile" title="JSONインポート" style="cursor:pointer;">⤵︎ インポート</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </header>

    <div class="row">
      <!-- 左：タイマー & KPI -->
      <section class="card">
        <h2>⏱ タイマー</h2>
        <p class="muted">科目を選んで「開始」。停止で自動保存されます。</p>
        <div class="controls" style="margin:8px 0 6px;">
          <select id="subjectSelect" aria-label="科目選択"></select>
          <button id="startBtn">開始</button>
          <button id="pauseBtn" disabled>一時停止</button>
          <button id="stopBtn" class="btn-danger" disabled>停止して保存</button>
        </div>
        <div class="timer" id="timerDisplay">00:00:00</div>
        <div class="subject-row">
          <input id="newSubjectInput" type="text" placeholder="科目を追加（例：数学）" />
          <button id="addSubjectBtn" class="btn-ghost">科目を追加</button>
        </div>
        <div class="subject-list" id="subjectList" style="margin-top:8px;"></div>

        <div class="kpis">
          <div class="kpi"><div class="muted">今日</div><div class="val" id="todayTotal">0:00</div></div>
          <div class="kpi"><div class="muted">今週</div><div class="val" id="weekTotal">0:00</div></div>
          <div class="kpi"><div class="muted">今月</div><div class="val" id="monthTotal">0:00</div></div>
        </div>
      </section>

      <!-- 右：グラフ -->
      <section class="card">
        <div class="section-title">
          <h2>📊 グラフ</h2>
          <div class="chips">
            <span class="chip tiny">棒：直近14日</span>
            <span class="chip tiny">円：直近30日</span>
          </div>
        </div>
        <div style="margin-top:8px">
          <canvas id="barChart" height="220"></canvas>
        </div>
        <div style="margin-top:16px">
          <canvas id="pieChart" height="220"></canvas>
        </div>
      </section>
    </div>

    <!-- ログ -->
    <section class="card" style="margin-top:16px;">
      <div class="section-title">
        <h2>📒 学習ログ</h2>
        <div class="chips">
          <button id="clearDataBtn" class="btn-danger" title="全データ削除">データを全消去</button>
        </div>
      </div>
      <table id="logTable">
        <thead>
          <tr>
            <th>日付</th>
            <th>開始</th>
            <th>終了</th>
            <th>科目</th>
            <th>時間</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <footer class="footer">
      <div class="tiny">データはこの端末のブラウザにのみ保存されます（LocalStorage）。</div>
      <div class="tiny">v1.0 — 配布はこのHTMLファイル1つでOK</div>
    </footer>
  </div>

  <script>
  ;(() => {
    const LS_KEYS = {
      subjects: 'study_subjects',
      sessions: 'study_sessions',
      theme: 'study_theme'
    }

    /** -------------------- ユーティリティ -------------------- */
    const pad = (n) => String(n).padStart(2, '0')
    const fmtHMS = (sec) => {
      const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60
      return `${pad(h)}:${pad(m)}:${pad(s)}`
    }
    const fmtHM = (sec) => {
      const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60)
      return `${h}:${pad(m)}`
    }
    const toDateKey = (d) => d.toISOString().slice(0,10)
    const parseISO = (s) => new Date(s)

    const load = (k, fallback) => {
      try{ const v = JSON.parse(localStorage.getItem(k)); return Array.isArray(fallback) && !Array.isArray(v) ? fallback : (v ?? fallback) }catch{ return fallback }
    }
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v))

    /** -------------------- 状態 -------------------- */
    let subjects = load(LS_KEYS.subjects, ["数学","英語","理科","社会","国語"])
    let sessions = load(LS_KEYS.sessions, []) // {id, subject, seconds, startISO, endISO, dateKey}

    // タイマー状態
    let ticking = false, paused = false, startAt = null, accSec = 0, tickHandle = null, currentSubject = subjects[0] || '学習'

    /** -------------------- DOM 参照 -------------------- */
    const subjectSelect = document.getElementById('subjectSelect')
    const startBtn = document.getElementById('startBtn')
    const pauseBtn = document.getElementById('pauseBtn')
    const stopBtn = document.getElementById('stopBtn')
    const timerDisplay = document.getElementById('timerDisplay')

    const newSubjectInput = document.getElementById('newSubjectInput')
    const addSubjectBtn = document.getElementById('addSubjectBtn')
    const subjectList = document.getElementById('subjectList')

    const todayTotalEl = document.getElementById('todayTotal')
    const weekTotalEl = document.getElementById('weekTotal')
    const monthTotalEl = document.getElementById('monthTotal')

    const logTableBody = document.querySelector('#logTable tbody')

    const exportBtn = document.getElementById('exportBtn')
    const importFile = document.getElementById('importFile')
    const clearDataBtn = document.getElementById('clearDataBtn')
    const toggleThemeBtn = document.getElementById('toggleThemeBtn')

    /** -------------------- テーマ -------------------- */
    const applyTheme = (mode) => {
      if(mode === 'light'){
        document.documentElement.style.setProperty('--bg', '#f7f8fb')
        document.documentElement.style.setProperty('--panel', '#ffffff')
        document.documentElement.style.setProperty('--text', '#0b0c10')
        document.documentElement.style.setProperty('--muted', '#5a6272')
        document.body.style.background = 'var(--bg)'
      } else {
        document.documentElement.style.removeProperty('--bg')
        document.documentElement.style.removeProperty('--panel')
        document.documentElement.style.removeProperty('--text')
        document.documentElement.style.removeProperty('--muted')
      }
      save(LS_KEYS.theme, mode)
    }
    applyTheme(load(LS_KEYS.theme, 'dark'))
    toggleThemeBtn.addEventListener('click', ()=>{
      const next = (load(LS_KEYS.theme, 'dark') === 'dark') ? 'light' : 'dark'
      applyTheme(next)
    })

    /** -------------------- 科目 -------------------- */
    function renderSubjects(){
      subjectSelect.innerHTML = ''
      subjects.forEach(sub => {
        const opt = document.createElement('option'); opt.value = sub; opt.textContent = sub; subjectSelect.appendChild(opt)
      })
      subjectSelect.value = currentSubject = subjects[0] || ''

      subjectList.innerHTML = ''
      subjects.forEach(sub=>{
        const pill = document.createElement('span')
        pill.className = 'subject-pill'
        pill.innerHTML = `${sub} <button title="削除">×</button>`
        pill.querySelector('button').addEventListener('click', ()=>{
          if(ticking && currentSubject === sub){ alert('進行中の科目は削除できません。'); return }
          subjects = subjects.filter(s=>s!==sub)
          save(LS_KEYS.subjects, subjects)
          renderSubjects()
          updateAll()
        })
        subjectList.appendChild(pill)
      })
    }
    renderSubjects()

    addSubjectBtn.addEventListener('click', ()=>{
      const v = newSubjectInput.value.trim()
      if(!v) return
      if(subjects.includes(v)) { alert('その科目は既にあります'); return }
      subjects.unshift(v)
      save(LS_KEYS.subjects, subjects)
      newSubjectInput.value = ''
      renderSubjects()
    })

    subjectSelect.addEventListener('change', (e)=>{ currentSubject = e.target.value })

    /** -------------------- タイマー -------------------- */
    function setButtons(){
      startBtn.disabled = ticking
      pauseBtn.disabled = !ticking
      stopBtn.disabled = !ticking
      pauseBtn.textContent = paused ? '再開' : '一時停止'
    }

    function tick(){
      const now = new Date()
      const elapsed = Math.floor((now - startAt)/1000) + accSec
      timerDisplay.textContent = fmtHMS(elapsed)
    }

    startBtn.addEventListener('click', ()=>{
      if(!currentSubject){ alert('科目を追加してください'); return }
      ticking = true; paused = false; startAt = new Date(); accSec = 0
      tick(); clearInterval(tickHandle); tickHandle = setInterval(tick, 1000)
      setButtons()
    })

    pauseBtn.addEventListener('click', ()=>{
      if(!ticking) return
      if(!paused){ // pause
        const now = new Date(); accSec += Math.floor((now - startAt)/1000)
        paused = true; clearInterval(tickHandle)
      } else { // resume
        startAt = new Date(); paused = false; tick(); tickHandle = setInterval(tick, 1000)
      }
      setButtons(); tick()
    })

    stopBtn.addEventListener('click', ()=>{
      if(!ticking) return
      const end = new Date()
      const seconds = Math.max(1, paused ? accSec : accSec + Math.floor((end - startAt)/1000))
      const startISO = new Date(end - seconds*1000).toISOString()
      const entry = {
        id: crypto.randomUUID(),
        subject: currentSubject,
        seconds,
        startISO,
        endISO: end.toISOString(),
        dateKey: toDateKey(end)
      }
      sessions.push(entry)
      save(LS_KEYS.sessions, sessions)

      // reset timer state
      ticking = false; paused = false; startAt = null; accSec = 0; clearInterval(tickHandle); timerDisplay.textContent = '00:00:00'
      setButtons();
      updateAll()
    })

    setButtons()

    /** -------------------- 集計 & 表示 -------------------- */
    function rangeDays(n){
      const arr=[]; const d = new Date(); d.setHours(0,0,0,0)
      for(let i=n-1;i>=0;i--){ const t = new Date(d); t.setDate(d.getDate()-i); arr.push(toDateKey(t)) }
      return arr
    }

    function isSameWeek(d1, d2){ // ISO week (Mon-Sun)
      const a = new Date(d1), b = new Date(d2)
      a.setHours(0,0,0,0); b.setHours(0,0,0,0)
      const day = (d)=> (d.getDay()+6)%7 // Mon=0
      const aMon = new Date(a); aMon.setDate(a.getDate()-day(a))
      const bMon = new Date(b); bMon.setDate(b.getDate()-day(b))
      return toDateKey(aMon) === toDateKey(bMon)
    }

    function sumSeconds(filterFn){ return sessions.filter(filterFn).reduce((s,e)=>s+e.seconds,0) }

    function updateKPIs(){
      const todayKey = toDateKey(new Date())
      const today = sumSeconds(e=> e.dateKey === todayKey)

      const now = new Date()
      const week = sumSeconds(e=> isSameWeek(parseISO(e.dateKey), now))

      const monthKey = now.toISOString().slice(0,7) // yyyy-mm
      const month = sumSeconds(e=> e.dateKey.startsWith(monthKey))

      todayTotalEl.textContent = fmtHM(today)
      weekTotalEl.textContent = fmtHM(week)
      monthTotalEl.textContent = fmtHM(month)
    }

    // グラフ
    let barChart, pieChart

    function updateBar(){
      const labels = rangeDays(14)
      const data = labels.map(day => sessions.filter(s=>s.dateKey===day).reduce((a,b)=>a+b.seconds,0)/3600)
      const ctx = document.getElementById('barChart').getContext('2d')
      const conf = {
        type:'bar',
        data:{ labels, datasets:[{ label:'時間(時間)', data, borderWidth:1 }] },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true } },
          plugins:{ legend:{ display:false } }
        }
      }
      if(barChart){ barChart.data = conf.data; barChart.update() } else { barChart = new Chart(ctx, conf) }
    }

    function updatePie(){
      // last 30 days by subject
      const from = new Date(); from.setDate(from.getDate()-29)
      const totals = {}
      sessions.forEach(s=>{
        const d = parseISO(s.dateKey)
        if(d >= new Date(from.toDateString())){
          totals[s.subject] = (totals[s.subject]||0) + s.seconds
        }
      })
      const labels = Object.keys(totals)
      const data = labels.map(k=> totals[k]/3600)
      const ctx = document.getElementById('pieChart').getContext('2d')
      const conf = {
        type:'doughnut',
        data:{ labels, datasets:[{ data }] },
        options:{ plugins:{ legend:{ position:'bottom' } } }
      }
      if(pieChart){ pieChart.data = conf.data; pieChart.update() } else { pieChart = new Chart(ctx, conf) }
    }

    function renderTable(){
      const rows = [...sessions].sort((a,b)=> b.startISO.localeCompare(a.startISO))
      logTableBody.innerHTML = ''
      for(const e of rows){
        const tr = document.createElement('tr')
        const start = new Date(e.startISO), end = new Date(e.endISO)
        const fmt = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
        const fmtTime = (d)=> `${pad(d.getHours())}:${pad(d.getMinutes())}`
        tr.innerHTML = `
          <td>${fmt(start)}</td>
          <td>${fmtTime(start)}</td>
          <td>${fmtTime(end)}</td>
          <td>${e.subject}</td>
          <td>${fmtHMS(e.seconds)}</td>
          <td><button class="btn-ghost tiny">削除</button></td>
        `
        tr.querySelector('button').addEventListener('click', ()=>{
          if(confirm('この記録を削除しますか？')){
            sessions = sessions.filter(s=> s.id !== e.id)
            save(LS_KEYS.sessions, sessions)
            updateAll()
          }
        })
        logTableBody.appendChild(tr)
      }
    }

    function updateAll(){
      updateKPIs(); updateBar(); updatePie(); renderTable()
    }

    updateAll()

    /** -------------------- エクスポート / インポート / 全消去 -------------------- */
    exportBtn.addEventListener('click', ()=>{
      const payload = { subjects, sessions }
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'})
      const a = document.createElement('a')
      const ymd = toDateKey(new Date()).replaceAll('-','')
      a.href = URL.createObjectURL(blob)
      a.download = `study-data-${ymd}.json`
      a.click()
      URL.revokeObjectURL(a.href)
    })

    importFile.addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return
      const reader = new FileReader()
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result)
          if(!obj || !Array.isArray(obj.subjects) || !Array.isArray(obj.sessions)) throw new Error('不正なファイル')
          if(!confirm('現在のデータを置き換えます。よろしいですか？')) return
          subjects = obj.subjects; sessions = obj.sessions
          save(LS_KEYS.subjects, subjects); save(LS_KEYS.sessions, sessions)
          renderSubjects(); updateAll()
          importFile.value = ''
        }catch(err){ alert('読み込みに失敗しました: ' + err.message) }
      }
      reader.readAsText(file)
    })

    clearDataBtn.addEventListener('click', ()=>{
      if(!confirm('すべての記録を削除します。元に戻せません。')) return
      sessions = []; save(LS_KEYS.sessions, sessions)
      updateAll()
    })

    // ページ離脱時、進行中なら注意（保存は停止時）
    window.addEventListener('beforeunload', (e)=>{
      if(ticking){ e.preventDefault(); e.returnValue = '' }
    })
  })()
  </script>
</body>
</html>